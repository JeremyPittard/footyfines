---
import { db, Players, Fines, Payments } from "astro:db";
const players = await db.select().from(Players);
const fines = await db.select().from(Fines);
const payments = await db.select().from(Payments);


---

<div class="overflow-x-auto py-8 mx-auto max-w-7xl">
  <table class="min-w-full bg-white font-[sans-serif]">
    <thead class="whitespace-nowrap bg-warriors-100 rounded">
      <tr>
        <th class="px-6 py-4 text-left text-lg font-semibold text-black">
          Player
        </th>
        <th class="px-6 py-4 text-left text-lg font-semibold text-black">
          Total Fines
        </th>
        <th class="px-6 py-4 text-left text-lg font-semibold text-black">
          Paid
        </th>
        <th class="px-6 py-4 text-left text-lg font-semibold text-black">
          edit
        </th>
      </tr>
    </thead>
    <tbody class="whitespace-nowrap">
      {
        // TODO: return as own component//move the funciton into a util or something
        players.map(({ name, id }:{name:string, id:number}) => {
          const playerFines:any[] = fines.filter((fine:any) => fine.playerId === id);
          const playerPayments:any[] = payments.filter((payment:any) => payment.playerId === id);
          const totalFines: number = playerFines.reduce(
            (total:number, fine:any) => total + fine.amount,
            0
          );
          const totalPayments: number = playerPayments.reduce((total:number, payment:any) => total + payment.amount, 0);

          return (
            <tr class="hover:bg-warriors-50">
                <td class="px-6 py-3">
                <form method="POST">
                    <input type="hidden" name="playerId" value={id} />
                    <label for="newFine">add more</label>
                    <input type="number" value="5" id="newFine" name="newFine" />
                    <button type="submit">add</button>
                    </form>
              </td>
              <td class="px-6 py-3 text-lg">
                <div class="flex items-center">
                    <!-- if image go here -->
                  <div class="ml-4">
                    <p class="text-lg text-black">{name}</p>
                  </div>
                </div>
              </td>
              <td class="px-6 py-3 text-lg">
                ${totalFines}
                <p class="text-xs text-gray-400 mt-1">In Process</p>
              </td>
              <td class="px-6 py-3 text-lg">
                ${totalPayments}
                <p class="text-xs text-gray-400 mt-1">Paid</p>
              </td>
            </tr>
          );
        })
      }
     

    </tbody>
  </table>
  <form method="POST" class="flex flex-col max-w-2xl mt-12">
    <label for="newPlayer">Add Player</label>
    <input type="text" id="newPlayer" name="newPlayer"/>
    <button type="submit">add</button>
    </form>
</div>
