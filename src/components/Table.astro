---
import { db, Players, Fines, Payments } from "astro:db";
const players = await db.select().from(Players);
const fines = await db.select().from(Fines);
const payments = await db.select().from(Payments);
---

<div class="overflow-x-auto py-8 mx-auto max-w-7xl">
  <table class="min-w-full bg-white font-[sans-serif]">
    <thead class="whitespace-nowrap bg-warriors-100 rounded">
      <tr>
        <th class="px-6 py-4 text-left text-lg font-semibold text-black">
          Player
        </th>
        <th class="px-6 py-4 text-left text-lg font-semibold text-black">
          Total Fines
        </th>
        <th class="px-6 py-4 text-left text-lg font-semibold text-black">
          Paid
        </th>
        <th class="px-6 py-4 text-left text-lg font-semibold text-black">
          Progress
        </th>
      </tr>
    </thead>
    <tbody class="whitespace-nowrap">
      {
        // TODO: return as own component//move the funciton into a util or something
        players.map(({ name, id }:{name:string, id:number}) => {
          const playerFines:any[] = fines.filter((fine:any) => fine.playerId === id);
          const playerPayments:any[] = payments.filter((payment:any) => payment.playerId === id);
          const totalFines:number = playerFines.reduce(
            (total:number, fine:any) => total + fine.amount,
            0
          );
          const totalPayments:number = playerPayments.reduce((total:number, payment:any) => total + payment.amount, 0);
          const percent:number = Math.floor((totalPayments / totalFines) * 100);

          return (
            <tr class="hover:bg-warriors-50">
              <td class="px-6 py-3 text-lg">
                <div class="flex items-center">
                    <!-- if image go here -->
                  <div class="ml-4">
                    <p class="text-lg text-black">{name}</p>
                  </div>
                </div>
              </td>
              <td class="px-6 py-3 text-lg">
                ${totalFines}
                <p class="text-xs text-gray-400 mt-1">In Process</p>
              </td>
              <td class="px-6 py-3 text-lg">
                ${totalPayments}
                <p class="text-xs text-gray-400 mt-1">Paid</p>
              </td>
              <td class="px-6 py-3">
                <div class="bg-gray-300 rounded-full w-full h-3">
                  <div
                    class={`w-[var(--custom-width)] h-full rounded-full bg-warriors-500`}
                    style={`--custom-width: ${percent}%`}
                  />
                </div>
                <p class="text-xs text-gray-400 mt-1">
                  Total : ${totalPayments}/${totalFines}
                </p>
              </td>
            </tr>
          );
        })
      }
    </tbody>
  </table>
</div>
